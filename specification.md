# GIT使用规范

## 1. 制定目的

在开发中使GIT管理代码，是为了提高协作开发的效率。为了高效利用GIT，特制定本规范，明确项目中GIT和类Github平台的使用方法。

## 2. 术语说明

> 仅对本文定义的术语和易混术语进行说明

|   术语   |     英文     |   类型   |                                     说明                                     |
| :------: | :----------: | :------: | :--------------------------------------------------------------------------: |
| 关键分支 |      -       | 本文定义 |        指多个协作者共同贡献代码的分支，如`master`、`release`、`dev`等        |
| 私有分支 |      -       | 本文定义 | 指单个协作者控制的分支或仓库，用于储存协作者独立编写代码，进而合并到关键分支 |
| 合并请求 | Pull Request |   git    |      亦称"拉取请求"，简称PR，为了降低沟通成本，统一称“合并请求”、“合并”      |
| 代码评审 | Code Review  |   git    |         对合并入关键分支之前的代码进行必要的检查，保证提交代码的质量         |

## 3. 分支管理

### 3.1. 对关键分支进行权限控制

包括`master`、`dev`等分支在内的关键分支，不可以直接推送代码，只能使用pull request进行变更。  
协作者开发过程中，根据所开发的内容建立私有分支进行开发。

### 3.2. 分支命名规范

分支的命名遵循以下规范：

|   作用   |         名称          |                        说明                         |
| :------: | :-------------------: | :-------------------------------------------------: |
| 主干分支 |       `master`        |          稳定的，已经发布或即将发布的分支           |
| 开发分支 |         `dev`         |           开发完成的功能全部合并到该分支            |
| 开发功能 | `feat-<feature_name>` |                                                     |
| 修复缺陷 |   `fix-<bug_name>`    |                                                     |
| 发布分支 | `release[-<version>]` | 从dev签出，最终合并入master分支，做发布前的最后调整 |

### 3.3. 移除非必要分支

已经合并或确认废弃的分支，应该及时删除。已经合并的分支，在PR页面直接选择删除；未发起PR或因其他原因终止开发的分支，应由创建人调用命令删除。  

## 4. 提交(`commit`)管理

`commit`由文件变更和Message组成。作为记录变更的最小单元，应该严肃对待每一个`commit`。

### 4.1. 一个`commit`只实现一个功能或部分功能

一个`commit`中所有变更都为了实现同一个的功能。不能将两个功能混合为同一个`commit`。且变更后项目应该处于一个稳定的状态，能够通过既有的测试。

### 4.2. 一个`commit`不能修改大量文件

保证单次提交变更的文件数量在**30**个以内，10个以内尤佳。降低阅读变更的难度，保证代码是易评审的。大量变更应该合理的拆分成多个`commit`。

### 4.3. 按照格式要求拟定提交信息

提交信息的的首行按照 `<type>(<scope>): <subject>`的格式编写，且总长度不得超过50个字符。  
`type`表示变更的类型，只可从以下几个类型中选择:

| type     | 说明                                     |
| -------- | ---------------------------------------- |
| feat     | 用于功能开发                             |
| fix      | 用于修复缺陷                             |
| docs     | 表示文档相关工作                         |
| style    | 代码格式的调整                           |
| refactor | 重构                                     |
| test     | 变更测试相关内容                         |
| chore    | 杂务，与代码无关的事务，如自动化脚本变更 |

`scope`为可选字段，指变更影响的范围，该关键字并无特定的范围，根据不同项目自行拟定，通俗易懂即可。  
`subject`为`commit`变更的主题，至少包含一个**动作**和该动作操作的**对象**。  

- ✅ fix(Scheduler): 修复状态检查过于频繁的问题
- ❌ fix(Scheduler): 修复一个BUG
- ❌ fix(Scheduler): 状态检查过于频繁

- Message可以选择性携带正文，必要时可以使用正文描述提交
- 当两个`commit`应该视为一个`commit`时，使用`git rebase`将两次提交变基为一次提交，常见在：
  - 一个功能的`commit`创建之后代码又进行了调整，调整部分形成了新的`commit`；
  - 开发中对`commit`的颗粒度预估有误，导致`commit`拆分的过于细碎；

必要时可为提交信息附加正文，用于进一步描述无法在`subject`中描述清楚的信息。

### 4.4. 保持`commit`历史为线性

通过使用`git rebase`等命令保证提交记录与`dev`分支(或其他关键分支)同步，避免使用`git merge`和`git pull`等会产生merge记录的命令。

## 5. 使用合并请求(`PR`)贡献代码

合并请求用于向他人描述代码的变更，并藉此展开必要的讨论交流。同样也是代码评审的依据。  
在协作者对此部分变更没有异议之后，仓库管理员将这部分变更合并到目标分支。  
在创建合并请求的过程中，应该遵循以下原则：

### 5.1. 合理的创建和编写PR

- 一个PR只聚焦一个功能或问题，避免不相关的`commit`混用同一个PR
- PR的标题要正确描述本PR的主题
- PR的正文要对本次变更进行必要的说明，或指向本次PR对应的需求说明、缺陷说明
- 正在编写中的代码，对应的PR在标题中标注WIP，并在功能完成后移除WIP标记
  
  > 例: WIP: 添加用户管理相关API

### 5.2. 正确设置PR的构型

PR创建之后，按照特定仓库的约定，执行以下操作：

- 选择PR的标签
- 连接相关issue
- 选择合适的评审人，申请代码评审

### 5.3. 保证沟通记录可追溯

代码评审和PR讨论中，保证关键信息体现在PR中。合理使用@mention功能，确保参与人及时获取最新的讨论动态。  

### 5.4. 在PR的讨论和修改中，保证提交记录整洁

代码编写完成且创建PR之后，会进入CI测试和评审环节。在此后发生的代码变更产生的`commit`记录，有可能会污染原本的提交记录。为了保证关键分支记录整洁，应将后续的调整变更视为原始设计，使用`git rebase`对`commit`记录进行重新组织,再行合并入关键分支。  
合并PR时，优先使用[`rebase and merge`](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/about-pull-request-merges#rebase-and-merge-your-pull-request-commits)模式保证关键分支的线性历史。  
协作者在创建PR之前、自己的PR被合并之后，都需要执行`git rebase {origin}/{branch}`命令，保证本地分支的`commit`记录与远程一致。
  > 注意：此处可能会出现冲突，因此应尽早同步远程变更，避免积累冲突。

### 5.5. 冲突解决原则

协作开发中，两个`commit`修改了同一个文件时，有可能会发生冲突(`conflict`)，解决冲突遵循主干优先、合理优先、工作量优先的原则:

- 与已经合并的代码产生冲突，应该由自己解决；
- 两个PR相互冲突无法同时合并时，优先合并更合理的一方，如果不存在合理性优劣，则选择总工作量更小的合并顺序；

## 6. 杂项

### 6.1. 仓库中添加必要的、正确的文件

向仓库添加文件时，应该遵循以下原则：

- 项目中**必须**包含`.gitignore`文件
- 将编辑器配置文件添加到`.gitignore`，如`.idea`、`.vscode`
- 在添加文件时，应该避免使用`git add .`，显式添加发生变更的文件；
- 应该避免添加临时文件到代码仓库；
- 保证提交到远程仓库的行尾序列为`LF`，而不是`CRLF`；

### 6.2. 涉密内容禁止添加到代码仓库

涉密内容应该通过对应的方案进行管理，而不是与代码一起提交到代码仓库。包括：

- 第三方服务的用户密码等鉴权信息
- 服务端加密使用的`Secret Key`等
- CI/CD流程中的服务器鉴权信息等

### 6.3. 版本发布与留存

当项目开发到达特定发布节点时，需要使用git的标签功能，在master分支对已经发布的版本进行标注。如果有对应的制品，亦可加入到release中进行留存。

## 7. 附录

### 7.1. 附录：常见场景指南
