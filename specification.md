# GIT使用规范

## 1. 制定目的

在开发中使GIT管理代码，是为了提高协作开发的效率。为了高效利用GIT，特制定本规范，明确项目中GIT和类Github平台的使用方法。

## 2. 术语说明

> 仅对本文定义的术语和易混术语进行说明

|术语|英文|类型|说明|
|:-:|:-:|:-:|:-:|
|关键分支|-|本文定义|指多个协作者共同贡献代码的分支，如`master`、`release`、`dev`等|
|私有分支|-|本文定义|指单个协作者控制的分支或仓库，用于储存协作者独立编写代码，进而合并到关键分支|
|合并请求|Pull Request|git|亦称"拉取请求"，简称PR，为了降低沟通成本，统一称“合并请求”、“合并”|
|代码评审|Code Review|git|对合并入关键分支之前的代码进行必要的检查，保证提交代码的质量|

## 3. 一般性要求

### 3.1. 对分支进行权限控制

关键分支要进行权限管理，避免协作者误提交未经审查的代码。

- 关键分支添加写保护，禁止直接推送代码，使用合并请求进行变更
- 协作者在私有分支进行开发，并基于私有分支创建合并请求


### 3.2. 严肃对待提交(`commit`)

`commit`由文件变更和Message组成。在创建一个Commit时，应该遵循以下原则：

- `commit`中变更的文件是彼此紧密相关的。如: 为了实现某个功能而变更的若干文件，单独作为一个`commit`；
- 不要在一个`commit`中变更大量文件；
- 将Message的第一行视为标题，标题要明确的描述本次变更的主题
  - ✅ feat: 实现#32定义的算法
  - ✅ fix: 修复程序无法正常退出的Bug(#15)
  - ❌ “添加新功能”
  - ❌ “解决一个BUG”
  - ❌ "fix" / "update" 等
  - ❌ 提交标题过长，导致阅读困难
  > 标题常见问题是信息缺失，核心信息至少有**动作**和**内容**两部分，*添加了什么*，*删除了什么*。
- Message可以选择性携带正文，必要时可以使用正文描述提交
- 当两个`commit`应该视为一个`commit`时，使用`git rebase`将两次提交变基为一次提交，常见在：
  - 一个功能的`commit`创建之后代码又进行了调整，调整部分形成了新的`commit`；
  - 开发中对`commit`的颗粒度预估有误，导致`commit`拆分的过于细碎；

### 3.3. 使用合并请求(`PR`)贡献代码

合并请求用于向他人描述你的代码变更，并藉此展开必要的讨论交流。同样也是代码评审的依据。  

在协作者对此部分变更没有异议之后，仓库管理员将这部分变更合并到目标分支。

在创建合并请求的过程中，应该遵循以下原则：

- 一个PR只聚焦一个功能或问题，避免不相关的commit混用同一个PR
- PR的标题要正确描述本PR的主题
- PR的正文要对本次变更进行必要的说明，或指向本次PR对应的需求说明、缺陷说明
- 正在编写中的代码，对应的PR在标题中标注WIP，并在功能完成后移除WIP标记
  
  > 例: WIP: 添加用户管理相关API
  
- 在PR中保持`commit`记录整洁
 
  > 常见一个场景是，代码编写完成后创建PR，经CI集成测试或评审后需要对代码进行调整变更。调整变更可能会污染提交记录。为了保证关键分支提交记录的整洁，应将调整变更视为原始设计，使用`git rebase`对`commit`记录进行重新组织,再合并入关键分支。
- 合并PR时，优先使用[`rebase and merge`](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/about-pull-request-merges#rebase-and-merge-your-pull-request-commits)模式保证关键分支的线性历史
- 协作者在创建PR之前、自己的PR被合并之后，都需要执行`git rebase {origin}/{branch}`命令，保证本地分支的`commit`记录与远程一致；
  
  > 注意：此处可能会出现冲突，因此应尽早同步远程变更，避免积累冲突。

- 冲突解决遵循主干优先、合理优先、工作量优先原则：
  - 与已经合并的代码产生冲突，应该由自己解决；
  - 两个PR相互冲突无法同时合并时，优先合并更合理的一方，如果不存在合理性优劣，则选择工作量较小的一种合并顺序；

## 4. 其他要求

### 4.1. 仓库中添加必要的、正确的文件

向仓库添加文件时，应该遵循以下原则：

- 项目中**必须**包含`.gitignore`文件
- 将编辑器配置文件添加到`.gitignore`，如`.idea`、`.vscode`
- 在添加文件时，应该避免使用`git add .`，显式添加发生变更的文件；
- 应该避免添加临时文件到代码仓库；
- 保证提交到远程仓库的行尾序列为`LF`，而不是`CRLF`；

### 4.2. 涉密内容禁止添加到代码仓库

涉密内容应该通过对应的方案进行管理，而不是与代码一起提交到代码仓库。包括：

- 第三方服务的用户密码等鉴权信息
- 服务端加密使用的`Secret Key`等
- CI/CD流程中的服务器鉴权信息等

### 4.3. 版本发布与留存

当项目开发到达特定发布节点时，需要使用GIT的标签功能，对当前版本进行标注。如果有对应制品，亦可加入到release中进行留存。

